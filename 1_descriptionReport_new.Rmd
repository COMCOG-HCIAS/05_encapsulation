---
output:
  pdf_document: default
  html_document:
    df_print: paged
documentclass: report
---

```{r rmd setup, include=FALSE}
knitr::opts_chunk$set(echo  = FALSE,
                      cache = TRUE,
                      message = FALSE)
```

```{r global settings, include=FALSE}
# response variables
response_vec <- c("TRT","FRT","RRT")
```

\input{0_tex/1_titlepage}
\createTitlepage{Anaphoric Encapsulation
}{Outlier information \& Description
}{Marie Scherzer\\Lona Koers
}


```{r R setup, warning=FALSE}
# load packages
library(knitr)        # output table editing etc.
library(readxl)       # reading Excel files
library(tidyverse)    # data management and ggplot2
library(DPKogHelpers) # Helper functions for the DPKog project
theme_set(theme_bw()) # set global theme for ggplot2 plots

# define paths
path_rawData  <- "0_data/1_rawData/"
path_prepData <- "0_data/2_preparedData/"
```


```{r read data}
# list all raw data Excel files
files <- list.files(path_rawData)
files <- as.list(files[grepl("xls", tolower(files))])
# read data
dat_list <- suppressWarnings(lapply(files, function(file) readxl::read_excel(paste0(path_rawData, file), sheet = 1, na = "."))) # data specific

# only choose the first data set in the list, which is the new data
dat_list[[2]] <- NULL
```

#### Dimension of the data
```{r data dimension}
strings <- lapply(seq_len(length(dat_list)), function(i) {
  paste0("\n", files[i], ": ", paste(dim(dat_list[[i]]), collapse = " x "))
})
string_dataDim <- paste(strings, collapse = "\n")
```
<!-- print the result of the upper chunk -->
`r string_dataDim`


#### Distribution of AOIs
```{r aoi distribution, message=FALSE}
tab_list <- lapply(seq_len(length(dat_list)), function(i) {
  dat <- as.data.frame(table(sub("_.*", "", dat_list[[1]]$IA_ID))) %>%
    dplyr::rename(AOI = Var1) %>% mutate(AOI = as.character(AOI))
  colnames(dat)[2] <- paste0("h_file",i)
  return(dat)
})
tab <- Reduce(left_join, tab_list)
tab[is.na(tab)] <- 0 # for if one AOI is not appearing in one dataset
knitr::kable(tab)
```


```{r data specific, warning=F}
library(stringr)
dat_list[[1]][is.na(dat_list[[1]])] <- 0
dat_list[[1]]$`IA_LABEL` <- as.character(dat_list[[1]]$`IA_ID`)
dat_list[[1]]$AOI.condition <- str_sub(dat_list[[1]]$`CONDITION+AOI+SET`, start = 1, end = -4)
dat_list[[1]]$Condition <- dat_list[[1]]$condition
dat_list[[1]]$Topic <- dat_list[[1]]$set
```


```{r data preparation}
# define observation and trials
for (i in seq_len(length(dat_list))) {
  dat_list[[i]]$Participant <- paste0(i, dat_list[[i]]$DATA_FILE)
  dat_list[[i]]$trial <- paste0(dat_list[[i]]$Topic, "_", dat_list[[i]]$Condition)
  dat_list[[i]]$observation <- paste0(dat_list[[i]]$trial, "_", dat_list[[i]]$Participant)
}

# create one big dataset
dat <- dplyr::bind_rows(dat_list)

# rename variables and define letters per word and AOI.conditions
dat <- dat %>%
  dplyr::rename("TRT"      = "AOI_TOTAL_READING_TIME",
                "FRT"      = "AOI_FIRST_PASS_READING_TIME",
                "RRT"      = "AOI_REREADING_TIME", 
                "nLetters" = "CHARACTER_COUNT",
                "nWords"   = "WORD_COUNT",
                "AOI"      = "IA_ID") %>%
  mutate(TRT.WD = TRT / nWords,
         FRT.WD = FRT / nWords,
         RRT.WD = RRT / nWords,
         nLetters.WD = nLetters / nWords)

# ensure that all reading time variables are of class numeric
vars <- paste0(rep(response_vec, times = 2), rep(c("",".WD"), each = length(response_vec)))
for (var in vars)
  dat[,var] <- as.numeric(unlist(dat[,var]))

# table(dat$Condition)
# table(dat[, c("AOI", "Condition")])
# length(unique(dat$trial))
# length(unique(dat$Participant))
# length(unique(dat$observation))
# table(dat[, c("trial", "Participant")]) # not all stimuli presented to all participants
# table(table(dat[, c("trial", "Participant")])) # one stimulus 9 times repeated within one experiment (per participant)
```


```{r checks}
error_messages <- c()

# Missing values in the response?
for (var in response_vec) {
  if (any(is.na(dat[,var]))) {
    error_messages <- append(error_messages, paste0("Missing values exist in ",var,"!"))
  }
}

# Check pre-calculated reading times per word
for (var in response_vec) {
  if (any(dat[,var]/dat$nWords != dat[,paste0(var,".WD")])) {
    error_messages <- append(error_messages,
                             c(paste0("The values of ",var,".WD differ from ",var,"/nWords!"),
                               paste0("  -> Calculate values of ",var,".WD anew.")))
    dat[,paste0(var,".WD")] <- dat[,var]/dat$nWords
  }
}

# Final message
if (length(error_messages) == 0)
  error_messages <- "No inconsistencies found."
```
<!-- print the error messages, if there are any -->
`r DPKogHelpers::print_rmdMessages(error_messages, title = "### Consistency checks")`


#### Distribution of AOI.conditions
```{r distribution aoi.cond, message=FALSE}
tab <- table(dat$AOI.condition) %>% as.data.frame() %>%
  dplyr::rename(AOI.condition = Var1, h = Freq)
knitr::kable(tab)
```


\newpage
## Outlier handling

Project specific definition of outliers:
    
    1. Any.first.skip: First Pass Reading Time in AOI 1 (OT) = 0ms 
    2. Any.fast.reader (extremely low values): First Pass Reading Time in AOI 1 (OT) <80ms 
    and Re-Reading Time in AOI 1 <80ms
    3. Any.slow.reader (extremely high values): Total Reading Time in AOI 1 (OT) >800ms

```{r outliers any.first.skip}
# sum(dat$AOI == 1 & dat$FRT.WD == 0)
# --> no observations were a first skip
messages <- c()
aois1 <- c(1) 
outlier1 <- lapply(aois1, function(aoi) { dat %>% filter(AOI == aoi & FRT.WD == 0)})
for (i in seq_len(length(aois1))) {
  new_message <- paste0(nrow(outlier1[[i]])," outliers in AOI '",aois1[i],"'.",
                 "\n",length(unique(outlier1[[i]]$observation)),
                 " (",paste0(100*round(length(unique(outlier1[[i]]$observation)) / 
                                         length(unique(dat$observation)),3),"%"),
                 ") of all observations are affected.")
  messages <- append(messages, new_message)
}
```
<!-- print the messages -->
`r DPKogHelpers::print_rmdMessages(messages, title = "### 1. Any.first.skip")`

```{r outliers any.fast.reader}
# sum(dat$AOI == 1 & dat$FRT.WD < 80 & dat$RRT.WD < 80)
# --> no observations are fast readers
messages <- c()
aois2 <- c(1)
outlier2 <- lapply(aois2, function(aoi) { dat %>% filter(AOI == aoi & (FRT.WD < 80 & RRT.WD < 80))}) 
for (i in seq_len(length(aois2))) {
  new_message <- paste0(nrow(outlier2[[i]])," outliers in AOI '",aois2[i],"'.",
                 "\n",length(unique(outlier2[[i]]$observation)),
                 " (",
                 paste0(100*round(length(unique(outlier2[[i]]$observation)) /
                                         length(unique(dat$observation)),3),"%"),
                 ") of all observations are affected.")
  messages <- append(messages, new_message)
}
```
<!-- print the messages -->
`r DPKogHelpers::print_rmdMessages(messages, title = "### 2. Any.fast.reader")`

```{r outliers any.slow.reader}
# sum(dat$AOI == 1 & dat$TRT.WD > 800)
# --> 1 observation is slow reading
messages <- c()
aois3 <- c(1)
outlier3 <- lapply(aois3, function(aoi) { dat %>% filter(AOI == aoi & TRT.WD > 800) }) 

for (i in seq_len(length(aois3))) {
  new_message <- paste0(nrow(outlier3[[i]])," outliers in AOI '",aois3[i],"'.",
                 "\n",length(unique(outlier3[[i]]$observation)),
                 " (",paste0(100*round(length(unique(outlier3[[i]]$observation)) /
                                         length(unique(dat$observation)),3),"%"),
                 ") of all observations are affected.")
  messages <- append(messages, new_message)
}
```
<!-- print the messages -->
`r DPKogHelpers::print_rmdMessages(messages, title = "### 3. Any.slow.reader")`

```{r outlier deletion}
outlier <- dplyr::bind_rows(outlier1, outlier2, outlier3)
dat_new <- dat %>% filter(!(observation %in% unique(outlier$observation)))
```

#### Detailed information on outliers

Outliers were detected in `r length(unique(outlier$Participant))` of `r length(unique(dat$Participant))` participants.

Overall, `r length(unique(outlier$observation))` 
(i.e. `r paste0(100*round(length(unique(outlier$observation))/length(unique(dat$observation)),3),"%")`)
of `r length(unique(dat$observation))` observations were excluded.

```{r outliers negative values}
error_messages <- c()
for (var in response_vec) {
  if (any(dat[,paste0(var,".WD")] < 0))
    error_messages <- append(error_messages, paste0("--- Negative values exist in ",var,"!"))
}
if (length(error_messages) == 0)
  error_messages <- "No negative reading times found."
```
<!-- print the error messages, if there are any -->
`r DPKogHelpers::print_rmdMessages(error_messages, title = "#### Negative values after outlier exclusion")`

#### Distribution after exclusion of outliers
```{r outlier plots, fig.height=7, dev='png'}
dat_new$AOI <- as.character(dat_new$AOI)
vars <- c("AOI", paste0(response_vec, ".WD"))
plot_dat <- dat_new %>% select(!!vars) %>%
  gather("response", "value", -AOI)
ggplot(plot_dat, aes(x = AOI, y = value)) +
  geom_boxplot() +
  facet_wrap(~ response, nrow = length(response_vec), scales = "free") +
  labs(y = "Reading time per word (ms)")
```



```{r export}
# save prepared data as .csv
write.csv2(dat_new, file = paste0(path_prepData, "data_prepared_new.csv"), row.names = F, fileEncoding = "utf-8")
message <- paste0("The prepared data were successfully saved as '",path_prepData,"data_prepared_new.csv'.")
```
<!-- print the message -->
`r DPKogHelpers::print_rmdMessages(message, title = "### Export data")`
